# /.github/workflows/deploy.yaml
# This CI/CD pipeline automates application deployment to the EKS cluster.

name: Deploy to EKS

on:
  push:
    branches:
      - main
    paths:
      # Trigger the workflow only if Kubernetes manifests have changed.
      - 'kubernetes/**'

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    permissions:
      contents: read # Permission to checkout the repository

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.29.0' # Use a specific version for consistency

      - name: Configure kubeconfig for EKS
        run: |
          # The KUBE_CONFIG_DATA secret must be the base64-encoded output of the
          # `aws eks update-kubeconfig` command generated by Terraform.
          echo "Configuring Kubeconfig..."
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > ~/.kube/config
          echo "Kubeconfig configured."

      - name: Deploy to EKS using Kustomize
        run: |
          # 'kubectl apply -k' processes the kustomization.yaml file and applies
          # all the referenced manifests to the cluster.
          echo "Applying Kubernetes manifests..."
          kubectl apply -k kubernetes/
          echo "Deployment successful! ðŸŽ‰"